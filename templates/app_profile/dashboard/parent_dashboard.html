{% load static %}

<!-- Cartes de statistiques -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">{{ dashboard_data.children|length|default:0 }}</h3>
                        <p class="mb-0">Enfants</p>
                    </div>
                    <div>
                        <i class="fas fa-child fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">{{ dashboard_data.children_recent_grades|length|default:0 }}</h3>
                        <p class="mb-0">Notes récentes</p>
                    </div>
                    <div>
                        <i class="fas fa-clipboard-list fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">{{ dashboard_data.children_recent_absences|length|default:0 }}</h3>
                        <p class="mb-0">Absences récentes</p>
                    </div>
                    <div>
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">{{ dashboard_data.children_upcoming_assessments|length|default:0 }}</h3>
                        <p class="mb-0">Examens à venir</p>
                    </div>
                    <div>
                        <i class="fas fa-calendar-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Taux de présence par enfant -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Taux de présence par enfant</h5>
            </div>
            <div class="card-body">
                {% if dashboard_data.children_attendance %}
                <div id="childrenAttendanceChart" style="min-height: 300px;"></div>
                {% else %}
                <p class="text-muted text-center">Aucune donnée de présence disponible</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Alertes -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-bell me-2"></i>Alertes</h5>
            </div>
            <div class="card-body">
                {% if dashboard_data.children_attendance %}
                    {% for item in dashboard_data.children_attendance %}
                        {% if item.unexcused_absences > 0 %}
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>{{ item.child.profile.full_name|default:item.child.profile.user.username }}</strong><br>
                            {{ item.unexcused_absences }} absence(s) non justifiée(s)
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if not dashboard_data.children_attendance or dashboard_data.children_attendance|length == 0 %}
                <p class="text-muted text-center">Aucune alerte</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Notes récentes des enfants -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-clipboard-list me-2"></i>Notes récentes</h5>
            </div>
            <div class="card-body">
                {% if dashboard_data.children_recent_grades %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Enfant</th>
                                <th>Matière</th>
                                <th>Note</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grade in dashboard_data.children_recent_grades %}
                            <tr>
                                <td>{{ grade.student.profile.full_name|default:grade.student.profile.user.username }}</td>
                                <td>{{ grade.assessment.subject.name }}</td>
                                <td>
                                    <span class="badge {% if grade.score >= 16 %}bg-success{% elif grade.score >= 14 %}bg-info{% elif grade.score >= 10 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ grade.score|floatformat:2 }}/{{ grade.assessment.max_score|default:20 }}
                                    </span>
                                </td>
                                <td>{{ grade.assessment.date|date:"d/m/Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">Aucune note récente</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Prochains examens -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-calendar-check me-2"></i>Prochains examens</h5>
            </div>
            <div class="card-body">
                {% if dashboard_data.children_upcoming_assessments %}
                <div class="list-group">
                    {% for assessment in dashboard_data.children_upcoming_assessments %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ assessment.subject.name }}</h6>
                                <p class="mb-1 text-muted">{{ assessment.name }} - {{ assessment.class_section.name }}</p>
                                <small class="text-muted">{{ assessment.category.name }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ assessment.date|date:"d/m" }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">Aucun examen à venir</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Absences récentes -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-user-times me-2"></i>Absences récentes</h5>
            </div>
            <div class="card-body">
                {% if dashboard_data.children_recent_absences %}
                <div class="list-group">
                    {% for absence in dashboard_data.children_recent_absences %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ absence.student.profile.full_name|default:absence.student.profile.user.username }}</h6>
                                <p class="mb-1 text-muted">{{ absence.student.class_section.name }}</p>
                                <small class="text-muted">{{ absence.start_date|date:"d/m/Y" }}{% if absence.end_date %} - {{ absence.end_date|date:"d/m/Y" }}{% endif %}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge {% if absence.is_justified %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if absence.is_justified %}Justifiée{% else %}Non justifiée{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">Aucune absence récente</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Enfants -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-users me-2"></i>Mes enfants</h5>
            </div>
            <div class="card-body">
                {% if dashboard_data.children %}
                <div class="list-group">
                    {% for child in dashboard_data.children %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ child.profile.full_name|default:child.profile.user.username }}</h6>
                                <small class="text-muted">{{ child.class_section.name|default:"Non assigné" }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-info">{{ child.student_number }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">Aucun enfant enregistré</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Actions rapides -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-bolt me-2"></i>Actions rapides</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{% url 'app_profile:my_parent_profile' %}" class="btn btn-primary">
                        <i class="fas fa-user me-1"></i> Mon profil parent
                    </a>
                    <a href="{% url 'app_profile:profile_view' %}" class="btn btn-info">
                        <i class="fas fa-id-card me-1"></i> Mon profil
                    </a>
                    {% if can_edit_profile %}
                    <a href="{% url 'app_profile:profile_update' %}" class="btn btn-warning">
                        <i class="fas fa-edit me-1"></i> Modifier mon profil
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_javascript %}
{{ dashboard_data.children_attendance|json_script:"children-attendance-data" }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graphique de présence par enfant
    var childrenDataElement = document.getElementById('children-attendance-data');
    if (childrenDataElement) {
        var childrenData = JSON.parse(childrenDataElement.textContent);
    var childrenNames = childrenData.map(function(item) { 
        return item.child && item.child.profile ? (item.child.profile.full_name || item.child.profile.user.username) : 'Enfant ' + item.child.id; 
    });
    var attendanceRates = childrenData.map(function(item) { return item.attendance_rate || 0; });
    
    var attendanceOptions = {
        series: [{
            name: 'Taux de présence',
            data: attendanceRates
        }],
        chart: {
            type: 'bar',
            height: 300,
            toolbar: { show: false }
        },
        xaxis: {
            categories: childrenNames
        },
        yaxis: {
            min: 0,
            max: 100,
            title: { text: 'Taux (%)' }
        },
        colors: ['#34c38f'],
        plotOptions: {
            bar: {
                borderRadius: 4,
                dataLabels: {
                    position: 'top'
                }
            }
        },
        dataLabels: {
            enabled: true,
            formatter: function(val) {
                return val.toFixed(1) + '%';
            }
        }
    };
    
        var attendanceChart = new ApexCharts(document.querySelector("#childrenAttendanceChart"), attendanceOptions);
        attendanceChart.render();
    }
});
</script>
{% endblock %}

