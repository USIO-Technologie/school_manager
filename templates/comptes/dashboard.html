{% extends "base.html" %}
{% load static %}

{% block title %}{{ nom_ecole }} - Tableau de bord{% endblock %}

{% block extra_javascript %}
  <!-- Chart.js (ajouté au-dessus des scripts de page) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
  <!-- En-tête page -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center gap-3">
      <div class="d-inline-flex align-items-center gap-1">
        <span class="rounded-circle bg-primary d-inline-block" style="width:10px;height:10px;"></span>
        <span class="rounded-circle bg-warning d-inline-block" style="width:10px;height:10px;"></span>
        <span class="rounded-circle bg-danger d-inline-block" style="width:10px;height:10px;"></span>
      </div>
      <div>
        <h4 class="mb-0 fw-semibold">{{ nom_ecole }}</h4>
        <small class="text-muted">{{ ville_ecole }}, {{ pays_ecole }}</small>
      </div>
    </div>
    <div class="mt-3 mt-md-0">
      <a href="{% url 'comptes:choisir_ecole' %}" class="btn btn-sm btn-outline-secondary">
        Changer d'école
      </a>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3">
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 small">Effectif total</p>
          <div class="d-flex align-items-baseline">
            <h3 class="mb-0" id="effectif">-</h3>
            <span class="ms-2 text-muted small">élèves</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 small">Nombre de classes</p>
          <div class="d-flex align-items-baseline">
            <h3 class="mb-0" id="n_classes">-</h3>
            <span class="ms-2 text-muted small">classes</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 small">Total encaissé</p>
          <h3 class="mb-0" id="total_encaisse">-</h3>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1 small">Taux de présence du jour</p>
          <div class="d-flex align-items-baseline">
            <h3 class="mb-0" id="taux_presence">-</h3>
            <span class="ms-2 text-muted small">%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Graph + Timeline -->
  <div class="row g-4 mt-1">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Chiffre d'affaires mensuel</h6>
            <div class="d-inline-flex gap-1">
              <span class="rounded-circle bg-primary d-inline-block" style="width:8px;height:8px;"></span>
              <span class="rounded-circle bg-warning d-inline-block" style="width:8px;height:8px;"></span>
              <span class="rounded-circle bg-danger d-inline-block" style="width:8px;height:8px;"></span>
            </div>
          </div>
          <div class="mt-3" style="height:320px;">
            <canvas id="revenue_chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Activités récentes</h6>
            <div class="d-inline-flex gap-1">
              <span class="rounded-circle bg-primary d-inline-block" style="width:8px;height:8px;"></span>
              <span class="rounded-circle bg-warning d-inline-block" style="width:8px;height:8px;"></span>
              <span class="rounded-circle bg-danger d-inline-block" style="width:8px;height:8px;"></span>
            </div>
          </div>

          <ul class="list-unstyled mt-3 mb-0" id="timeline">
            <li class="text-muted small">Chargement des activités...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascript %}
<script>
// ---- Utils
function formatCurrency(amount) {
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0
  }).format(amount);
}

// ---- State
let revenueChart = null;

async function updateDashboard() {
  try {
    const res = await fetch("{% url 'comptes:dashboard_data' %}" || '/dashboard/data/');
    const data = await res.json();

    // KPIs
    document.getElementById('effectif').textContent      = data.effectif ?? '-';
    document.getElementById('n_classes').textContent     = data.n_classes ?? '-';
    document.getElementById('total_encaisse').textContent= formatCurrency(data.total_encaisse ?? 0);
    document.getElementById('taux_presence').textContent = Number(data.taux_presence ?? 0).toFixed(1);

    // Chart
    const ctx = document.getElementById('revenue_chart').getContext('2d');
    if (revenueChart) revenueChart.destroy();
    revenueChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.chart?.labels ?? [],
        datasets: [{
          label: "Chiffre d'affaires",
          data: data.chart?.values ?? [],
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.12)',
          pointRadius: 3,
          fill: true,
          tension: 0.35
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: { label: ctx => formatCurrency(ctx.parsed.y) }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: v => formatCurrency(v) },
            grid: { color: 'rgba(0,0,0,0.06)' }
          },
          x: { grid: { display: false } }
        },
        interaction: { mode: 'index', intersect: false }
      }
    });

    // Timeline
    const list = document.getElementById('timeline');
    const items = (data.timeline ?? []).map((msg, i, arr) => `
      <li class="position-relative ps-4 mb-3">
        ${i !== arr.length - 1 ? '<span class="position-absolute top-0 start-0 translate-middle-y" style="left:6px; height:100%; width:1px; background:#e9ecef;"></span>' : ''}
        <span class="position-absolute start-0 translate-middle-y rounded-circle bg-primary" style="width:8px;height:8px; top:10px;"></span>
        <span class="small text-muted">${msg}</span>
      </li>
    `).join('');
    list.innerHTML = items || '<li class="text-muted small">Aucune activité récente.</li>';

  } catch (e) {
    console.error('Erreur dashboard:', e);
  }
}

// Initial + refresh
updateDashboard();
setInterval(updateDashboard, 30000);
</script>
{% endblock %}
