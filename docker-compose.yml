services:
  # ===============================
  #  Application Django
  # ===============================
  school_manager:
    build: .                                # Construit l'image Docker à partir du Dockerfile local
    container_name: school_manager            # Nom du conteneur pour identification
    command: /entrypoint.sh                 # Commande exécutée au démarrage (souvent : migrations + runserver/gunicorn)
    user: "1000:1000"                       # Évite d’utiliser root pour des raisons de sécurité
    volumes:
      - .:/app                              # Monte le code source local dans le conteneur
      - ./staticfiles:/app/staticfiles      # Dossier partagé pour les fichiers statiques collectés
    ports:
      - "8004:8000"                         # Expose le port 8000 du conteneur sur le port 8004 de l’hôte
    restart: always                         # Redémarre automatiquement en cas de crash
    env_file:
      - .env                                # Fichier contenant les variables d’environnement
    environment:
      - DJANGO_SETTINGS_MODULE=school_manager.prod_settings   # Force les paramètres de production
    depends_on:
      - db                                  # Attendre que Postgres soit prêt
      - redis                               # Nécessaire pour Celery (broker)
    networks:
      - web_network                         # Réseau partagé entre les conteneurs

  # ===============================
  #  Celery Worker
  # ===============================
  celery_worker:
    build: .                                # Utilise le même Dockerfile que Django
    container_name: celery_worker_school
    command: celery -A school_manager.celery worker -l info  # Lance le worker Celery
    volumes:
      - .:/app
    restart: always
    env_file:
      - .env
    environment:
      - DJANGO_SETTINGS_MODULE=school_manager.prod_settings
    depends_on:
      - db
      - redis
    networks:
      - web_network

  # ===============================
  #  Celery Beat
  # ===============================
#  celery_beat:
#    build: .
#    container_name: celery_beat
#    command: celery -A school_manager.celery beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
#    volumes:
#      - .:/app
#    restart: always
#    env_file:
#      - .env
#    environment:
#      - DJANGO_SETTINGS_MODULE=school_manager.prod_settings
#    depends_on:
#      - db
#      - redis
#    networks:
#      - web_network

  # ===============================
  #  Redis
  # ===============================
  redis:
    image: redis:7
    container_name: school_manager_redis
    restart: always
    networks:
      - web_network

  # ===============================
  #  PostgreSQL
  # ===============================
  db:
    image: postgres:17
    container_name: school_manager_db
    restart: always
    environment:
      POSTGRES_DB: school_manager_db
      POSTGRES_USER: school_manager_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Utiliser une variable d’environnement pour la sécurité
    volumes:
      - /apps/school_manager/postgres_data:/var/lib/postgresql/data   #  Stockage persistant sur disque
    networks:
      - web_network

# ===============================
#  Réseau Docker partagé
# ===============================
networks:
  web_network:
    driver: bridge

volumes:
  postgres_data: